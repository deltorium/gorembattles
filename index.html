<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOREM OS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --main: #00ff88; --bg: #0f0f13; --card: #1e1e24; --text: #fff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; padding-bottom: 70px; }
        
        .header { padding: 20px; background: linear-gradient(180deg, rgba(0,255,136,0.1), transparent); text-align: center; border-bottom: 1px solid #333; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--main); margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 30px; background: #333; background-size: cover; background-position: center; }
        .balance { font-size: 28px; font-weight: bold; margin: 10px 0; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card-box { background: var(--card); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #333; cursor: pointer; }
        .btn { width: 100%; padding: 10px; background: var(--main); border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; cursor: pointer; color: black; }
        .btn-red { background: #ff4444; color: white; }
        
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 100; overflow-x: auto;}
        .tab-btn { background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.5; padding: 5px; }
        .tab-btn.active { opacity: 1; transform: scale(1.2); }

        .page { display: none; padding: 15px; }
        .page.active { display: block; }

        /* CHAT */
        #chat-list { height: 60vh; overflow-y: auto; margin-bottom: 60px; padding: 10px; display: flex; flex-direction: column-reverse;}
        .msg { margin-bottom: 10px; padding: 8px 12px; background: #222; border-radius: 8px; font-size: 14px; }
        .msg.system { background: rgba(255, 215, 0, 0.1); border-left: 3px solid gold; color: #ffd700; }
        .msg-name { font-weight: bold; color: var(--main); font-size: 12px; margin-bottom: 2px; }
        .chat-input-area { position: fixed; bottom: 70px; width: 100%; background: #111; padding: 10px; display: flex; box-sizing: border-box; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }

        /* INVENTORY */
        .inv-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .inv-card { background: #222; border-radius: 5px; overflow: hidden; cursor: pointer; position: relative; }
        .inv-card img { width: 100%; height: 100px; object-fit: cover; }
        .inv-count { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); padding: 2px 5px; font-size: 10px; }
        
        /* MODAL */
        #modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #modal img { width: 200px; border-radius: 10px; border: 2px solid var(--main); }
        .modal-close { position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; }
        
        input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        .list-item { background: var(--card); padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; display:flex; justify-content:center; align-items:center;">Connecting...</div>

    <div class="header">
        <div class="avatar" id="u-ava"></div>
        <div id="u-name" style="margin-top:5px; font-weight:bold;">User</div>
        <div class="balance"><span id="u-bal">0</span> ğŸª™</div>
        <div style="color:#00aaff; font-weight:bold;"><span id="u-crypto">0</span> MTC</div>
    </div>

    <!-- HOME -->
    <div id="home" class="page active">
        <h3>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</h3>
        <button class="btn" onclick="api('farm')">â›ï¸ Ğ¤ĞĞ Ğœ (+100)</button>
        <button class="btn" onclick="location.href='game.html'" style="margin-top:10px; background:#aa00ff; color:white;">âš”ï¸ GOREM BATTLES</button>
        
        <h3>Ğ˜Ğ³Ñ€Ñ‹</h3>
        <div class="grid">
            <div class="card-box" onclick="showRoulette()">
                <h1>ğŸ²</h1>
                <div>Ğ ÑƒĞ»ĞµÑ‚ĞºĞ°</div>
            </div>
             <div class="card-box" onclick="nav('lab', document.getElementById('btn-lab'))">
                <h1>ğŸ§ª</h1>
                <div>Ğ›Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¸Ñ</div>
            </div>
        </div>

        <h3>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h3>
        <div class="grid">
            <div class="card-box"><div>Ğ’Ğ°Ğ¹Ğ¿Ñ‹</div><h2 id="u-wipes">0</h2></div>
            <div class="card-box"><div>ĞšĞ°Ñ€Ñ‚Ñ‹</div><h2 id="u-cards">0</h2></div>
        </div>
        
        <input type="text" id="promo-code" placeholder="ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´">
        <button class="btn" style="width:auto;" onclick="usePromo()">OK</button>
    </div>

    <!-- CHAT -->
    <div id="chat" class="page" style="padding:0;">
        <div id="chat-list"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...">
            <button class="btn" style="width:auto; margin:0 0 0 5px;" onclick="sendChat()">â¤</button>
        </div>
    </div>

    <!-- SHOP -->
    <div id="shop" class="page">
        <h3>ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</h3>
        <div class="grid">
            <div class="card-box" onclick="buy('common', 50)">ğŸ“¦ Common<br><small>50 ğŸª™</small></div>
            <div class="card-box" onclick="buy('rare', 150)">ğŸŸ¦ Rare<br><small>150 ğŸª™</small></div>
            <div class="card-box" onclick="buy('premium', 300)">ğŸŸª Premium<br><small>300 ğŸª™</small></div>
            <div class="card-box" onclick="buy('mythic', 1000)">ğŸŸ§ Mythic<br><small>1000 ğŸª™</small></div>
            <div class="card-box" onclick="buy('secret', 5000)">â¬› Secret<br><small>5000 ğŸª™</small></div>
            <div class="card-box" onclick="buy('business', 15000)">ğŸ’¼ Business<br><small>15000 ğŸª™</small></div>
            <div class="card-box" onclick="buy('platinum', 500000)" style="border-color:gold; color:gold;">ğŸ‘‘ Platinum<br><small>500k ğŸª™</small></div>
        </div>
    </div>

    <!-- LAB -->
    <div id="lab" class="page">
        <h3>ĞšÑ€Ğ°Ñ„Ñ‚</h3>
        <div id="recipes-list"></div>
    </div>

    <!-- CRYPTO -->
    <div id="crypto" class="page">
        <h1 style="text-align:center; color:#00aaff;">ğŸ’ <span id="mtc-price">0</span></h1>
        <canvas id="chart" style="width:100%; height:200px; margin: 10px 0;"></canvas>
        <input type="number" id="trade-amount" placeholder="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾">
        <div class="grid">
            <button class="btn" onclick="trade('buy')">ĞšĞ£ĞŸĞ˜Ğ¢Ğ¬</button>
            <button class="btn btn-red" onclick="trade('sell')">ĞŸĞ ĞĞ”ĞĞ¢Ğ¬</button>
        </div>
    </div>

    <!-- FIRM -->
    <div id="firm" class="page">
        <div id="firm-exists" style="display:none;">
            <h2 id="firm-name" style="text-align:center;"></h2>
            <div class="card-box">ĞšĞ°Ğ·Ğ½Ğ°: <span id="firm-bal">0</span> ğŸª™</div>
            <input type="number" id="donate-amount" placeholder="Ğ¡ÑƒĞ¼Ğ¼Ğ°" style="margin-top:10px;">
            <button class="btn" onclick="firmAction('donate')">Ğ’Ğ½ĞµÑÑ‚Ğ¸ Ğ² ĞºĞ°Ğ·Ğ½Ñƒ</button>
        </div>
        <div id="firm-none">
            <h3>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„Ğ¸Ñ€Ğ¼Ñƒ</h3>
            <input type="text" id="new-firm-name" placeholder="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ">
            <button class="btn" onclick="firmAction('create')">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ (100k ğŸª™)</button>
            <h3>Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ¸Ñ€Ğ¼</h3>
            <div id="firm-list">Loading...</div>
            <input type="number" id="join-id" placeholder="ID Ğ¤Ğ¸Ñ€Ğ¼Ñ‹" style="margin-top:20px;">
            <button class="btn" onclick="firmAction('join')">Ğ’ÑÑ‚ÑƒĞ¿Ğ¸Ñ‚ÑŒ</button>
        </div>
    </div>

    <!-- TOP -->
    <div id="top" class="page">
        <h3>Ğ¢Ğ¾Ğ¿ Ğ‘Ğ¾Ğ³Ğ°Ñ‡ĞµĞ¹</h3>
        <div id="top-list"></div>
    </div>

    <!-- INVENTORY -->
    <div id="inv" class="page">
        <div class="inv-grid" id="inv-grid"></div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="nav('home', this)">ğŸ </button>
        <button class="tab-btn" onclick="nav('chat', this)">ğŸ’¬</button>
        <button class="tab-btn" onclick="nav('shop', this)">ğŸ›’</button>
        <button class="tab-btn" onclick="nav('crypto', this)">ğŸ“ˆ</button>
        <button class="tab-btn" onclick="nav('firm', this)">ğŸ¢</button>
        <button class="tab-btn" id="btn-lab" onclick="nav('lab', this)">ğŸ§ª</button>
        <button class="tab-btn" onclick="nav('top', this)">ğŸ†</button>
        <button class="tab-btn" onclick="nav('inv', this)">ğŸ’</button>
    </div>

    <div id="modal">
        <div class="modal-close" onclick="closeModal()">âœ–</div>
        <img id="m-img" src="">
        <h2 id="m-name"></h2>
        <p id="m-desc" style="color:#aaa;"></p>
        <div id="m-rarity" style="padding:5px; background:#333; border-radius:5px;"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // !!! Ğ—ĞĞœĞ•ĞĞ˜ ĞĞ Ğ¡Ğ’ĞĞ™ !!!
        const API_URL = "https://my-super-bot-1gwh.onrender.com"; 

        let user = tg.initDataUnsafe?.user || { id: 7328565195, first_name: "Test", username: "test" };
        let appData = {};
        let chartInstance = null;
        let chatInterval = null;

        async function init() {
            try {
                const avaDiv = document.getElementById('u-ava');
                avaDiv.innerText = user.first_name[0];
                
                const res = await fetch(`${API_URL}/api/get_user`, {
                    method: 'POST',
                    body: JSON.stringify({ user_id: user.id, first_name: user.first_name })
                });
                appData = await res.json();
                render();
                document.getElementById('loader').style.display = 'none';
            } catch(e) { alert("ĞÑˆĞ¸Ğ±ĞºĞ°: " + e); }
        }

        function render() {
            document.getElementById('u-name').innerText = appData.user.first_name;
            document.getElementById('u-bal').innerText = appData.user.balance;
            document.getElementById('u-crypto').innerText = appData.user.crypto_balance;
            document.getElementById('u-wipes').innerText = appData.user.wipe_count || 0;
            
            let totalCards = 0;
            const invDiv = document.getElementById('inv-grid');
            invDiv.innerHTML = "";
            appData.inventory.forEach(c => {
                totalCards += c.count;
                invDiv.innerHTML += `<div class="inv-card" onclick='showCard(${JSON.stringify(c)})'><img src="${c.image_url}"><div class="inv-count">x${c.count}</div></div>`;
            });
            document.getElementById('u-cards').innerText = totalCards;

            document.getElementById('mtc-price').innerText = appData.crypto.price;
            drawChart(appData.crypto.history);

            // Lab
            const labDiv = document.getElementById('recipes-list');
            labDiv.innerHTML = "";
            // Ğ’ v8.0 Ğ±Ğ¾Ñ‚Ğµ Ğ½ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¾Ğ² Ğ² init, Ğ½Ğ¾ Ğ¼Ñ‹ Ğ¸Ñ… Ğ·Ğ½Ğ°ĞµĞ¼
            // Ğ›Ğ¸Ğ±Ğ¾ Ñ…Ğ°Ñ€Ğ´ĞºĞ¾Ğ´Ğ¸Ğ¼, Ğ»Ğ¸Ğ±Ğ¾ Ğ±Ğ¾Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ñ… ÑĞ»Ğ°Ñ‚ÑŒ. Ğ’ ĞºĞ¾Ğ´Ğµ Ğ±Ğ¾Ñ‚Ğ° v8.0 Ñ Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ» Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¾Ğ², Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾.
            // ĞŸĞ¾ĞºĞ° Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€:
            const recipes = [
                {id: "astolfo", name: "ĞÑÑ‚Ğ¾Ğ»ÑŒÑ„Ğ¾", ings: ["Ğ½ĞµĞ¹Ñ€Ğ¾Ğ½ĞºĞ°", "Ğ¢Ğ¸Ğ¼Ğ¾Ñ„ĞµĞ¹", "ĞœĞ¸Ğ½ĞµÑ‚ĞºĞ°"]},
                {id: "kryptonit", name: "ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾-Ğ½Ğ¸Ñ‚", ings: ["Ğ²Ğ°Ñ„Ğ»Ñ", "Ğ²Ğ°Ğ»ĞµÑ€Ğ°", "Ğ¢Ğ¸Ğ¼Ğ¾Ñ„ĞµĞ¹"]},
                {id: "lagrande", name: "La Grande Ğ‘Ğ¾Ñ‚", ings: ["Iris Ğ±Ğ¾Ñ‚", "Ğ“Ğ¾Ñ€ĞµĞ¼ Ğ‘Ğ¾Ñ‚"]}
            ];
            recipes.forEach(r => {
                labDiv.innerHTML += `<div class="card-box" style="margin-bottom:10px;"><h3>${r.name}</h3><small>${r.ings.join(" + ")}</small><br><button class="btn" style="margin-top:5px;" onclick="api('craft', {recipe_id: '${r.id}'})">Ğ¡ĞºÑ€Ğ°Ñ„Ñ‚Ğ¸Ñ‚ÑŒ</button></div>`;
            });

            if (appData.firm) {
                document.getElementById('firm-exists').style.display = 'block';
                document.getElementById('firm-none').style.display = 'none';
                document.getElementById('firm-name').innerText = appData.firm.name;
                document.getElementById('firm-bal').innerText = appData.firm.balance;
            } else {
                document.getElementById('firm-exists').style.display = 'none';
                document.getElementById('firm-none').style.display = 'block';
                loadFirmsList();
            }
        }

        async function api(endpoint, payload={}) {
            tg.MainButton.showProgress();
            payload.user_id = user.id;
            try {
                const res = await fetch(`${API_URL}/api/${endpoint}`, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                tg.MainButton.hideProgress();
                if (data.success) {
                    if (data.msg) tg.showAlert(data.msg);
                    if (data.card) showCard(data.card);
                    init();
                } else { tg.showAlert(data.msg || "ĞÑˆĞ¸Ğ±ĞºĞ°"); }
            } catch(e) { tg.MainButton.hideProgress(); alert(e); }
        }

        async function loadChat() {
            try {
                const res = await fetch(`${API_URL}/api/chat_get`, { method: 'POST', body: JSON.stringify({ user_id: user.id }) });
                const data = await res.json();
                const list = document.getElementById('chat-list');
                list.innerHTML = "";
                // Reverse is handled by flex-direction
                data.messages.forEach(m => {
                    const cls = m.is_system ? 'msg system' : 'msg';
                    list.innerHTML += `<div class="${cls}"><div class="msg-name">${m.username}</div><div>${m.message}</div></div>`;
                });
            } catch(e) {}
        }

        async function sendChat() {
            const inp = document.getElementById('chat-input');
            const msg = inp.value;
            if(!msg) return;
            inp.value = "";
            await fetch(`${API_URL}/api/chat_send`, { method: 'POST', body: JSON.stringify({ user_id: user.id, name: user.first_name, message: msg }) });
            loadChat();
        }

        function showRoulette() {
            tg.showPopup({
                title: 'Ğ ÑƒĞ»ĞµÑ‚ĞºĞ°',
                message: 'Ğ¡Ğ´ĞµĞ»Ğ°Ğ¹Ñ‚Ğµ ÑÑ‚Ğ°Ğ²ĞºÑƒ:',
                buttons: [{id: '100', text: '100'}, {id: '1000', text: '1000'}, {id: 'all', text: 'Ğ’Ğ°-Ğ±Ğ°Ğ½Ğº'}]
            }, (btnId) => {
                if(btnId) {
                    let amt = btnId === 'all' ? appData.user.balance : parseInt(btnId);
                    api('roulette', { amount: amt });
                }
            });
        }

        function buy(type, price) { tg.showConfirm(`ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ ĞºĞµĞ¹Ñ ${type}?`, (ok) => { if(ok) api('buy_case', { type: type }); }); }
        function trade(op) { const val = document.getElementById('trade-amount').value; if(val) api('crypto_trade', { op: op, amount: val }); }
        function usePromo() { const code = document.getElementById('promo-code').value; if(code) api('promo', { code: code }); }
        function firmAction(act) {
            const payload = { act: act };
            if (act === 'create') payload.name = document.getElementById('new-firm-name').value;
            if (act === 'join') payload.fid = document.getElementById('join-id').value;
            if (act === 'donate') payload.amount = document.getElementById('donate-amount').value;
            api('firm', payload);
        }
        
        function nav(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'chat') { loadChat(); chatInterval = setInterval(loadChat, 3000); }
            else { if(chatInterval) clearInterval(chatInterval); }
            if(id === 'top') loadTop();
        }

        function showCard(c) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('m-img').src = c.image_url;
            document.getElementById('m-name').innerText = c.name;
            document.getElementById('m-desc').innerText = c.description || "";
            document.getElementById('m-rarity').innerText = c.rarity.toUpperCase();
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        async function loadTop() {
            const res = await fetch(`${API_URL}/api/top`, { method: 'POST', body: JSON.stringify({user_id: user.id}) });
            const data = await res.json();
            const list = document.getElementById('top-list');
            list.innerHTML = "";
            data.top.forEach((u, i) => { list.innerHTML += `<div class="list-item"><div>${i+1}. ${u.first_name}</div><div style="color:gold">${u.balance}</div></div>`; });
        }
        async function loadFirmsList() { document.getElementById('firm-list').innerText = "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ID Ñ„Ğ¸Ñ€Ğ¼Ñ‹ (Ğ£Ğ·Ğ½Ğ°Ğ¹Ñ‚Ğµ Ñƒ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°)"; }
        
        function drawChart(data) {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map((_, i) => i), datasets: [{ label: 'MTC', data: data, borderColor: '#00aaff', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: 'rgba(0, 170, 255, 0.1)' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#666' }, grid: { color: '#333' } } } }
            });
        }

        init();
    </script>
</body>
</html>
