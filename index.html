<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOREM OS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --main: #00ff88; --bg: #0f0f13; --card: #1e1e24; --text: #fff; --danger: #ff4444; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; padding-bottom: 80px; }
        
        .header { padding: 15px; background: linear-gradient(180deg, rgba(0,255,136,0.1), transparent); text-align: center; border-bottom: 1px solid #333; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--main); margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 24px; background: #333; background-size: cover; background-position: center; }
        .balance { font-size: 24px; font-weight: bold; margin: 5px 0; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        .card-box { background: var(--card); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #333; cursor: pointer; }
        .btn { width: 100%; padding: 10px; background: var(--main); border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; cursor: pointer; color: black; }
        .btn-red { background: var(--danger); color: white; }
        .btn-blue { background: #00aaff; color: white; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 100; overflow-x: auto; }
        .tab-btn { background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.5; padding: 0 10px; }
        .tab-btn.active { opacity: 1; transform: scale(1.2); color: var(--main); }

        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DECODE STYLE */
        #decode .card-box { border-color: var(--main); font-family: monospace; }
        .glitch { animation: glitch 1s infinite; }

        /* ADMIN PANEL */
        .admin-panel { border: 1px solid var(--danger); padding: 10px; border-radius: 10px; background: rgba(255,0,0,0.1); }
        .admin-title { color: var(--danger); text-align: center; text-transform: uppercase; margin-bottom: 10px; }
        
        /* CHAT & INV */
        #chat-list { height: 60vh; overflow-y: auto; margin-bottom: 50px; padding: 5px; display: flex; flex-direction: column-reverse; }
        .msg { margin-bottom: 8px; padding: 8px; background: #222; border-radius: 8px; font-size: 13px; }
        .msg.system { background: rgba(255, 215, 0, 0.1); border-left: 3px solid gold; color: #ffd700; }
        .msg-name { font-weight: bold; color: var(--main); font-size: 11px; }
        .chat-input-area { position: fixed; bottom: 70px; width: 100%; background: #111; padding: 10px; display: flex; box-sizing: border-box; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        
        .inv-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .inv-card { background: #222; border-radius: 5px; cursor: pointer; position: relative; aspect-ratio: 2/3; overflow: hidden; }
        .inv-card img { width: 100%; height: 100%; object-fit: cover; }
        .inv-count { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); padding: 2px 5px; font-size: 10px; }
        
        input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        .list-item { background: var(--card); padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; }

        /* MODAL */
        #modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #modal img { width: 200px; border: 2px solid var(--main); border-radius: 10px; margin-bottom: 15px;}
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; display:flex; justify-content:center; align-items:center;">Connecting...</div>

    <div class="header">
        <div class="avatar" id="u-ava"></div>
        <div id="u-name" style="margin-top:5px; font-weight:bold;">User</div>
        <div class="balance"><span id="u-bal">0</span> ğŸª™</div>
        <div style="font-size:12px; color:#aaa;">ID: <span id="u-id">...</span></div>
        <div style="color:#00aaff; font-weight:bold; margin-top:5px;"><span id="u-crypto">0</span> MTC</div>
    </div>

    <!-- HOME -->
    <div id="home" class="page active">
        <h3>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</h3>
        <button class="btn" onclick="api('farm')">â›ï¸ Ğ¤ĞĞ Ğœ (+100)</button>
        <button class="btn" onclick="location.href='game.html'" style="margin-top:10px; background:#aa00ff; color:white;">âš”ï¸ Ğ˜Ğ“Ğ ĞĞ¢Ğ¬</button>
        
        <h3>Ğ˜Ğ³Ñ€Ñ‹</h3>
        <div class="grid">
            <div class="card-box" onclick="nav('decode', document.getElementById('btn-decode'))">ğŸ’» Ğ”ĞµĞºĞ¾Ğ´ĞµÑ€</div>
            <div class="card-box" onclick="nav('events', document.getElementById('btn-events'))">ğŸ Ğ˜Ğ²ĞµĞ½Ñ‚Ñ‹</div>
        </div>

        <h3>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h3>
        <div class="grid">
            <div class="card-box"><div>Ğ’Ğ°Ğ¹Ğ¿Ñ‹</div><h2 id="u-wipes">0</h2></div>
            <div class="card-box"><div>ĞšĞ°Ñ€Ñ‚Ñ‹</div><h2 id="u-cards">0</h2></div>
        </div>
        <input type="text" id="promo-code" placeholder="ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´">
        <button class="btn" onclick="usePromo()">OK</button>
    </div>

    <!-- DECODE -->
    <div id="decode" class="page">
        <h2 style="color:var(--main); font-family:monospace;">> DECODER_V2.0</h2>
        <div class="grid">
            <div class="card-box" onclick="doDecode('x2')">ğŸ“ˆ x2 MTC<br><small>Ğ¨Ğ°Ğ½Ñ 40%</small></div>
            <div class="card-box" onclick="doDecode('crash')">ğŸ“‰ CRASH<br><small>ĞĞ±Ğ²Ğ°Ğ» Ñ€Ñ‹Ğ½ĞºĞ°</small></div>
            <div class="card-box" onclick="doDecode('gift')">ğŸ GIFT<br><small>Ğ’Ğ·Ğ»Ğ¾Ğ¼ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ°</small></div>
        </div>
        <div id="decode-log" style="font-family:monospace; color:#aaa; margin-top:20px;">ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ...</div>
    </div>

    <!-- EVENTS -->
    <div id="events" class="page">
        <div id="event-box" class="card-box" style="padding:30px;">
            <h1 id="event-title">Ğ¢Ğ¸ÑˆĞ¸Ğ½Ğ°...</h1>
            <p id="event-desc">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ²ĞµĞ½Ñ‚Ğ¾Ğ² Ğ½ĞµÑ‚.</p>
            <div id="boss-hp" style="display:none; color:red; font-weight:bold; font-size:24px;"></div>
            <button id="event-btn" class="btn hidden" style="display:none;" onclick="eventAction()">Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•</button>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin" class="page">
        <div class="admin-panel">
            <div class="admin-title">ğŸ‘‘ ADMIN PANEL</div>
            <input type="number" id="adm-id" placeholder="Target User ID">
            <input type="number" id="adm-amount" placeholder="Amount">
            <div class="grid">
                <button class="btn" onclick="adm('give_coins')">Give Coins</button>
                <button class="btn btn-red" onclick="adm('wipe_user')">WIPE</button>
            </div>
            <hr style="border-color:#444">
            <input type="text" id="adm-promo" placeholder="Promo Code">
            <button class="btn" onclick="adm('create_promo')">Create Promo</button>
            <hr style="border-color:#444">
            <h3>Events</h3>
            <div class="grid">
                <button class="btn btn-red" onclick="adm('trigger_event', {event_type: 'boss'})">Start Boss</button>
                <button class="btn" onclick="adm('trigger_event', {event_type: 'gift'})">Start Gift</button>
                <button class="btn" onclick="adm('stop_event')">Stop All</button>
            </div>
        </div>
    </div>

    <!-- CHAT -->
    <div id="chat" class="page" style="padding:0;">
        <div id="chat-list"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...">
            <button class="btn" style="width:auto; margin:0 0 0 5px;" onclick="sendChat()">â¤</button>
        </div>
    </div>

    <!-- SHOP -->
    <div id="shop" class="page">
        <h3>ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</h3>
        <div class="grid">
            <div class="card-box" onclick="buy('common', 50)">ğŸ“¦ Common<br><small>50 ğŸª™</small></div>
            <div class="card-box" onclick="buy('rare', 150)">ğŸŸ¦ Rare<br><small>150 ğŸª™</small></div>
            <div class="card-box" onclick="buy('premium', 300)">ğŸŸª Premium<br><small>300 ğŸª™</small></div>
            <div class="card-box" onclick="buy('mythic', 1000)">ğŸŸ§ Mythic<br><small>1000 ğŸª™</small></div>
            <div class="card-box" onclick="buy('secret', 5000)">â¬› Secret<br><small>5000 ğŸª™</small></div>
            <div class="card-box" onclick="buy('business', 15000)">ğŸ’¼ Business<br><small>15000 ğŸª™</small></div>
            <div class="card-box" onclick="buy('platinum', 500000)" style="border-color:gold; color:gold;">ğŸ‘‘ Platinum<br><small>500k ğŸª™</small></div>
        </div>
    </div>

    <!-- LAB -->
    <div id="lab" class="page">
        <h3>ĞšÑ€Ğ°Ñ„Ñ‚</h3>
        <div id="recipes-list"></div>
    </div>

    <!-- CRYPTO -->
    <div id="crypto" class="page">
        <h1 style="text-align:center; color:#00aaff;">ğŸ’ <span id="mtc-price">0</span></h1>
        <canvas id="chart" style="width:100%; height:200px; margin: 10px 0;"></canvas>
        <input type="number" id="trade-amount" placeholder="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾">
        <div class="grid">
            <button class="btn" onclick="trade('buy')">ĞšĞ£ĞŸĞ˜Ğ¢Ğ¬</button>
            <button class="btn btn-red" onclick="trade('sell')">ĞŸĞ ĞĞ”ĞĞ¢Ğ¬</button>
        </div>
    </div>

    <!-- FIRM -->
    <div id="firm" class="page">
        <div id="firm-exists" style="display:none;">
            <h2 id="firm-name" style="text-align:center;"></h2>
            <div class="card-box">ĞšĞ°Ğ·Ğ½Ğ°: <span id="firm-bal">0</span> ğŸª™</div>
            <input type="number" id="donate-amount" placeholder="Ğ¡ÑƒĞ¼Ğ¼Ğ°" style="margin-top:10px;">
            <button class="btn" onclick="firmAction('donate')">Ğ’Ğ½ĞµÑÑ‚Ğ¸ Ğ² ĞºĞ°Ğ·Ğ½Ñƒ</button>
        </div>
        <div id="firm-none">
            <h3>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„Ğ¸Ñ€Ğ¼Ñƒ</h3>
            <input type="text" id="new-firm-name" placeholder="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ">
            <button class="btn" onclick="firmAction('create')">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ (100k ğŸª™)</button>
            <h3>Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ¸Ñ€Ğ¼</h3>
            <div id="firm-list">Loading...</div>
            <input type="number" id="join-id" placeholder="ID Ğ¤Ğ¸Ñ€Ğ¼Ñ‹" style="margin-top:20px;">
            <button class="btn" onclick="firmAction('join')">Ğ’ÑÑ‚ÑƒĞ¿Ğ¸Ñ‚ÑŒ</button>
        </div>
    </div>

    <!-- TOP -->
    <div id="top" class="page">
        <h3>Ğ¢Ğ¾Ğ¿ Ğ‘Ğ¾Ğ³Ğ°Ñ‡ĞµĞ¹</h3>
        <div id="top-list"></div>
    </div>

    <!-- INVENTORY -->
    <div id="inv" class="page">
        <div class="inv-grid" id="inv-grid"></div>
    </div>

    <!-- NAVIGATION -->
    <div class="tab-bar">
        <button class="tab-btn active" onclick="nav('home', this)">ğŸ </button>
        <button class="tab-btn" onclick="nav('chat', this)">ğŸ’¬</button>
        <button class="tab-btn" onclick="nav('shop', this)">ğŸ›’</button>
        <button class="tab-btn" onclick="nav('crypto', this)">ğŸ“ˆ</button>
        <button class="tab-btn" onclick="nav('firm', this)">ğŸ¢</button>
        <button class="tab-btn" id="btn-decode" onclick="nav('decode', this)">ğŸ’»</button>
        <button class="tab-btn" id="btn-events" onclick="nav('events', this)">ğŸ</button>
        <button class="tab-btn" id="btn-admin" style="display:none; color:red;" onclick="nav('admin', this)">ğŸ‘‘</button>
        <button class="tab-btn" onclick="nav('inv', this)">ğŸ’</button>
    </div>

    <!-- MODAL -->
    <div id="modal">
        <div class="close-modal" onclick="document.getElementById('modal').style.display='none'">âœ–</div>
        <img id="m-img" src="">
        <h2 id="m-name"></h2>
        <p id="m-desc" style="color:#aaa;"></p>
        <div id="m-rarity" style="padding:5px; background:#333; border-radius:5px;"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // !!! URL Ğ’ĞĞ¨Ğ•Ğ“Ğ Ğ‘ĞĞ¢Ğ ĞĞ RENDER !!!
        const API_URL = "https://my-super-bot-1gwh.onrender.com"; 

        let user = tg.initDataUnsafe?.user || { id: 7328565195, first_name: "Test", username: "test" };
        let appData = {};
        let chartInstance = null;

        // Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ˜ Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ
        // Ğ•ÑĞ»Ğ¸ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ² HTML, Ğ¾Ğ½Ğ° Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµÑ‚ (Ğ½Ğµ ĞºÑ€Ğ°ÑˆĞ¸Ñ‚ ÑĞ°Ğ¹Ñ‚)
        function safeSet(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        async function init() {
            try {
                // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºÑƒ, ĞµÑĞ»Ğ¸ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ½ĞµÑ‚ - Ğ¸Ğ³Ğ½Ğ¾Ñ€
                const avaDiv = document.getElementById('u-ava');
                if(avaDiv) avaDiv.innerText = user.first_name[0];
                
                const res = await fetch(`${API_URL}/api/get_user`, {
                    method: 'POST',
                    body: JSON.stringify({ user_id: user.id, first_name: user.first_name })
                });
                appData = await res.json();
                
                if (appData.error) throw new Error(appData.error);
                
                render();
                
                const loader = document.getElementById('loader');
                if(loader) loader.style.display = 'none';
                
                // Show Admin Tab
                if (appData.is_admin) {
                    const btnAdmin = document.getElementById('btn-admin');
                    if(btnAdmin) btnAdmin.style.display = 'block';
                }

            } catch(e) { alert("Error: " + e); }
        }

        function render() {
            // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ safeSet Ğ²ĞµĞ·Ğ´Ğµ
            safeSet('u-name', appData.user.first_name);
            safeSet('u-id', appData.user.user_id);
            safeSet('u-bal', appData.user.balance);
            safeSet('u-crypto', appData.user.crypto_balance);
            safeSet('u-wipes', appData.user.wipe_count || 0);
            
            // Inventory
            let totalCards = 0;
            const invDiv = document.getElementById('inv-grid');
            if (invDiv) {
                invDiv.innerHTML = "";
                if (appData.inventory) {
                    appData.inventory.forEach(c => {
                        totalCards += c.count;
                        invDiv.innerHTML += `<div class="inv-card" onclick='showCard(${JSON.stringify(c)})'><img src="${c.image_url}"><div class="inv-count">x${c.count}</div></div>`;
                    });
                }
            }
            safeSet('u-cards', totalCards);

            // Crypto
            safeSet('mtc-price', appData.crypto.price);
            drawChart(appData.crypto.history);
            
            // Firm
            const firmExists = document.getElementById('firm-exists');
            const firmNone = document.getElementById('firm-none');
            
            if (appData.firm) {
                if(firmExists) firmExists.style.display = 'block';
                if(firmNone) firmNone.style.display = 'none';
                safeSet('firm-name', appData.firm.name);
                safeSet('firm-bal', appData.firm.balance);
            } else {
                if(firmExists) firmExists.style.display = 'none';
                if(firmNone) firmNone.style.display = 'block';
                loadFirmsList();
            }

            // Events
            const ev = appData.event;
            const evBtn = document.getElementById('event-btn');
            
            if (ev && ev.active) {
                if(evBtn) evBtn.style.display = 'inline-block'; // Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
                if (ev.type === 'boss') {
                    safeSet('event-title', "âš”ï¸ Ğ‘ĞĞ¡Ğ¡: ĞĞ›Ğ•ĞšĞ¡Ğ•Ğ™");
                    safeSet('event-desc', `HP: ${ev.boss_hp} / ${ev.boss_max}`);
                    if(evBtn) evBtn.innerText = "ĞĞ¢ĞĞšĞĞ’ĞĞ¢Ğ¬";
                } else {
                    safeSet('event-title', "ğŸ ĞŸĞĞ”ĞĞ ĞĞš");
                    safeSet('event-desc', "ĞšÑ‚Ğ¾-Ñ‚Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ» ĞºĞ¾Ñ€Ğ¾Ğ±ĞºÑƒ...");
                    if(evBtn) evBtn.innerText = "ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ¬";
                }
            } else {
                safeSet('event-title', "Ğ¢Ğ¸ÑˆĞ¸Ğ½Ğ°...");
                safeSet('event-desc', "Ğ˜Ğ²ĞµĞ½Ñ‚Ğ¾Ğ² Ğ½ĞµÑ‚.");
                if(evBtn) evBtn.style.display = 'none';
            }
        }

        async function api(endpoint, payload={}) {
            tg.MainButton.showProgress();
            payload.user_id = user.id;
            try {
                const res = await fetch(`${API_URL}/api/${endpoint}`, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                tg.MainButton.hideProgress();
                if (data.success) {
                    if (data.msg) tg.showAlert(data.msg);
                    if (data.card) showCard(data.card);
                    init();
                } else { tg.showAlert(data.msg || "ĞÑˆĞ¸Ğ±ĞºĞ°"); }
            } catch(e) { tg.MainButton.hideProgress(); alert(e); }
        }

        // --- NEW FUNCTIONS ---
        function doDecode(target) {
            safeSet('decode-log', "Ğ’Ğ·Ğ»Ğ¾Ğ¼...");
            setTimeout(() => { api('decode', { target: target }); }, 1000);
        }

        function eventAction() { api('event_interact'); }

        function adm(act, extra={}) {
            const payload = { act: act, ...extra };
            if (act === 'give_coins' || act === 'wipe_user') {
                payload.target_id = document.getElementById('adm-id').value;
                payload.amount = document.getElementById('adm-amount').value;
            }
            if (act === 'create_promo') {
                payload.code = document.getElementById('adm-promo').value;
                payload.amount = document.getElementById('adm-amount').value;
            }
            api('admin', payload);
        }

        async function loadChat() {
            const res = await fetch(`${API_URL}/api/chat_get`, { method: 'POST', body: JSON.stringify({ user_id: user.id }) });
            const data = await res.json();
            const list = document.getElementById('chat-list');
            if(list) {
                list.innerHTML = "";
                data.messages.forEach(m => {
                    const cls = m.is_system ? 'msg system' : 'msg';
                    list.innerHTML += `<div class="${cls}"><span class="msg-name">${m.username}</span>: ${m.message}</div>`;
                });
            }
        }
        function sendChat() {
            const inp = document.getElementById('chat-input');
            const msg = inp.value;
            if(msg) {
                inp.value = "";
                fetch(`${API_URL}/api/chat_send`, { method: 'POST', body: JSON.stringify({ user_id: user.id, name: user.first_name, message: msg }) }).then(loadChat);
            }
        }
        
        function buy(type, price) { tg.showConfirm(`ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ ĞºĞµĞ¹Ñ ${type}?`, (ok) => { if(ok) api('buy_case', { type: type }); }); }
        function trade(op) { const val = document.getElementById('trade-amount').value; if(val) api('crypto_trade', { op: op, amount: val }); }
        function usePromo() { const code = document.getElementById('promo-code').value; if(code) api('promo', { code: code }); }
        function firmAction(act) {
            const payload = { act: act };
            if (act === 'create') payload.name = document.getElementById('new-firm-name').value;
            if (act === 'join') payload.fid = document.getElementById('join-id').value;
            if (act === 'donate') payload.amount = document.getElementById('donate-amount').value;
            api('firm', payload);
        }

        function nav(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'chat') loadChat();
            if(id === 'top') loadTop();
        }
        
        function showCard(c) {
            const m = document.getElementById('modal');
            if(!m) return;
            m.style.display = 'flex';
            document.getElementById('m-img').src = c.image_url;
            safeSet('m-name', c.name);
            safeSet('m-desc', c.description || "");
            safeSet('m-rarity', c.rarity.toUpperCase());
        }

        async function loadTop() {
            const res = await fetch(`${API_URL}/api/top`, { method: 'POST', body: JSON.stringify({user_id: user.id}) });
            const data = await res.json();
            const list = document.getElementById('top-list');
            if(list) {
                list.innerHTML = "";
                data.top.forEach((u, i) => { list.innerHTML += `<div class="list-item"><div>${i+1}. ${u.first_name}</div><div style="color:gold">${u.balance}</div></div>`; });
            }
        }
        async function loadFirmsList() { 
            const el = document.getElementById('firm-list');
            if(el) el.innerText = "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ID Ñ„Ğ¸Ñ€Ğ¼Ñ‹"; 
        }
        
        function drawChart(data) {
            const cvs = document.getElementById('chart');
            if(!cvs) return;
            const ctx = cvs.getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map((_, i) => i), datasets: [{ label: 'MTC', data: data, borderColor: '#00aaff', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: 'rgba(0, 170, 255, 0.1)' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#666' }, grid: { color: '#333' } } } }
            });
        }

        init();
    </script>
</body>
</html>
