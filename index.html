<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOREM OS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main: #00ff88; --bg: #121214; --card: #1e1e24; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; padding-bottom: 70px; }
        
        /* HEADER */
        .header { padding: 20px; background: linear-gradient(180deg, rgba(0,255,136,0.1), transparent); text-align: center; }
        .balance { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .sub-balance { color: #888; font-size: 14px; }
        
        /* TABS */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
        .tab-btn { background: none; border: none; color: #555; font-size: 24px; cursor: pointer; }
        .tab-btn.active { color: var(--main); }
        
        /* SECTIONS */
        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        
        /* CARDS & ITEMS */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card { background: var(--card); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #333; }
        .btn { width: 100%; padding: 10px; background: var(--main); border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; cursor: pointer; color: black; }
        
        /* INVENTORY */
        .inv-item { display: flex; align-items: center; background: var(--card); margin-bottom: 5px; padding: 5px; border-radius: 5px; }
        .inv-img { width: 40px; height: 40px; background: #333; border-radius: 4px; margin-right: 10px; background-size: cover; }

        /* LOADING */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>

    <div id="loader">Loading Gorem OS...</div>

    <!-- HEADER -->
    <div class="header">
        <div id="user-name">User</div>
        <div class="balance"><span id="bal">0</span> ü™ô</div>
        <div class="sub-balance"><span id="crypto">0</span> MTC | <span id="firm">–ù–µ—Ç —Ñ–∏—Ä–º—ã</span></div>
    </div>

    <!-- MAIN PAGE -->
    <div id="home" class="page active">
        <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
        <button class="btn" onclick="api('farm')" style="height: 60px; font-size: 18px;">‚õèÔ∏è –§–ê–†–ú–ò–¢–¨ (+100)</button>
        <br><br>
        <h3>–ò–≥—Ä—ã</h3>
        <div class="grid">
            <div class="item-card" onclick="location.href='game.html'">
                <h1>‚öîÔ∏è</h1>
                <div>Gorem Battles</div>
            </div>
            <div class="item-card" onclick="alert('–°–∫–æ—Ä–æ!')">
                <h1>üé≤</h1>
                <div>–†—É–ª–µ—Ç–∫–∞</div>
            </div>
        </div>
    </div>

    <!-- SHOP PAGE -->
    <div id="shop" class="page">
        <h3>–ú–∞–≥–∞–∑–∏–Ω –ö–µ–π—Å–æ–≤</h3>
        <div class="grid">
            <div class="item-card">
                <h3>üì¶</h3>
                <div>Common</div>
                <div style="color:#aaa">50 ü™ô</div>
                <button class="btn" onclick="buyCase('common')">–ö—É–ø–∏—Ç—å</button>
            </div>
            <div class="item-card">
                <h3>üü¶</h3>
                <div>Rare</div>
                <div style="color:#aaa">150 ü™ô</div>
                <button class="btn" onclick="buyCase('rare')">–ö—É–ø–∏—Ç—å</button>
            </div>
            <div class="item-card">
                <h3>üüß</h3>
                <div>Mythic</div>
                <div style="color:#aaa">1000 ü™ô</div>
                <button class="btn" onclick="buyCase('mythic')">–ö—É–ø–∏—Ç—å</button>
            </div>
             <div class="item-card">
                <h3>üíº</h3>
                <div>Business</div>
                <div style="color:#aaa">15000 ü™ô</div>
                <button class="btn" onclick="buyCase('business')">–ö—É–ø–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- CRYPTO PAGE -->
    <div id="crypto-page" class="page">
        <h3>–ë–∏—Ä–∂–∞ MTC</h3>
        <div class="item-card" style="margin-bottom: 20px;">
            <h1>üíé <span id="mtc-price">...</span></h1>
            <div>–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å</div>
        </div>
        <input type="number" id="trade-amount" placeholder="–°—É–º–º–∞" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
        <div class="grid">
            <button class="btn" onclick="trade('buy')">–ö–£–ü–ò–¢–¨</button>
            <button class="btn" onclick="trade('sell')" style="background:#ff4444; color:white">–ü–†–û–î–ê–¢–¨</button>
        </div>
    </div>

    <!-- INVENTORY PAGE -->
    <div id="inventory" class="page">
        <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
        <div id="inv-list"></div>
    </div>

    <!-- TABS -->
    <div class="tab-bar">
        <button class="tab-btn active" onclick="nav('home')">üè†</button>
        <button class="tab-btn" onclick="nav('shop')">üõí</button>
        <button class="tab-btn" onclick="nav('crypto-page')">üìà</button>
        <button class="tab-btn" onclick="nav('inventory')">üéí</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // !!! –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL –ù–ê RENDER (–Ω–∞–ø—Ä–∏–º–µ—Ä https://my-bot.onrender.com) !!!
        const API_URL = "https://my-super-bot-1gwh.onrender.com"; 

        const user = tg.initDataUnsafe.user;
        let userData = {};

        async function init() {
            if(!user) { alert("–ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ –¢–µ–ª–µ–≥—Ä–∞–º!"); return; }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            try {
                const res = await fetch(`${API_URL}/api/get_user`, {
                    method: 'POST',
                    body: JSON.stringify({ user_id: user.id, first_name: user.first_name })
                });
                const data = await res.json();
                
                userData = data;
                renderData();
                document.getElementById('loader').style.display = 'none';
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: " + e);
            }
        }

        function renderData() {
            document.getElementById('user-name').innerText = userData.user.first_name;
            document.getElementById('bal').innerText = userData.user.balance;
            document.getElementById('crypto').innerText = userData.user.crypto_balance;
            document.getElementById('mtc-price').innerText = userData.crypto_price;
            
            const f = userData.firm;
            document.getElementById('firm').innerText = f ? f.name : "–ë–µ–∑—Ä–∞–±–æ—Ç–Ω—ã–π";

            // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            const invList = document.getElementById('inv-list');
            invList.innerHTML = "";
            userData.inventory.forEach(item => {
                invList.innerHTML += `
                    <div class="inv-item">
                        <div class="inv-img" style="background-image: url('${item.image_url}')"></div>
                        <div>
                            <div style="font-weight:bold">${item.name} x${item.count}</div>
                            <div style="font-size:12px; color:#aaa">${item.rarity}</div>
                        </div>
                    </div>
                `;
            });
        }

        async function api(endpoint, payload={}) {
            tg.MainButton.showProgress();
            payload.user_id = user.id;
            
            try {
                const res = await fetch(`${API_URL}/api/${endpoint}`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                
                tg.MainButton.hideProgress();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å–∏—Ç—å init, –Ω–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ç–∞–∫)
                    if(result.balance !== undefined) userData.user.balance = result.balance;
                    if(result.crypto !== undefined) userData.user.crypto_balance = result.crypto;
                    if(result.card) {
                        // –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –≤–∏–∑—É–∞–ª—å–Ω–æ (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –≤—Å–µ)
                        init(); 
                    }
                    renderData();
                } else {
                    tg.showAlert("–û—à–∏–±–∫–∞: " + result.message);
                }
            } catch(e) {
                tg.MainButton.hideProgress();
                tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            }
        }

        function buyCase(type) {
            tg.showConfirm(`–ö—É–ø–∏—Ç—å ${type} –∫–µ–π—Å?`, (ok) => {
                if(ok) api('buy_case', { type: type });
            });
        }

        function trade(op) {
            const amount = document.getElementById('trade-amount').value;
            if(!amount) return;
            api('crypto', { op: op, amount: amount });
        }

        function nav(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        init();
    </script>
</body>
</html>
